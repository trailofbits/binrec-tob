# Using BinRec to Transform Recovered Programs

In this short walkthrough, we take you through an advanced application of BinRec: applying performance or security hardening passes to recovered programs before recompilation. Our goal in the walkthrough is the same as our debloating walkthrough, only in this case we also want to apply LLVM's production quality optimization passes and sanitizers to the program. This will result in a program this is free of bloat, is as performant as possible, and has modern software protections built-in.

Please note that support for applying LLVM's passes to LLVM IR recovered by BinRec is experimental. The LLVM IR recovered by BinRec differs significantly from the LLVM IR Clang derives from source code, which can result in errors in the recompilation process or programs that crash. Users employing this functionality should thoroughly validate and test the recovered programs generated by BinRec.


1. To start, let's create a new analysis project, add some trace arguments, collect the trace data, and merge the traces as we did in the `debloating` walkthroughs:

   ```bash
   # just new-project <project_name> <path_to_target_binary>
   $ just new-project eqproj test/benchmark/samples/bin/x86/binrec/eq
   
   # just add-trace <project_name> <trace_name> <symbolic-indexes> <args>
   $ just add-trace eqproj tr1 "" "1 2"
   $ just add-trace eqproj tr2 "" "2 2"

   # just run <project_name>
   $ just run eqproj

   # just merge-traces <project_name>
   $ just merge-traces eqproj
   ```

2. Now, when we perform the lifitng operation, we will tell BinRec to run extra performance and/or security hardening optimizations:

   ```bash
   # just lift-trace <project_name> <transform_flags>
   $ just lift-trace eqproj --extra-opts --hardening
   ```

   This will lift the merged trace completely to LLVM IR, and then prior to recompilation run LLVM's passes on the refined IR. 

3. Finally, let's validate the debloated program outputs match the original:

   ```bash
   # just validate <project_name>
   $ just validate-eqproj
   ```
